#!/bin/bash

# Script to find first .jar file, unzip it, combine with another zip, and repackage
set -e  # Exit on any error

# Check if a folder path was provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <folder_path> <other_zip>"
    exit 1
fi

FOLDER_PATH="$1"
OTHER_ZIP="$2"

# Check if the folder exists
if [ ! -d "$FOLDER_PATH" ]; then
    echo "Error: Folder '$FOLDER_PATH' does not exist"
    exit 1
fi

# Find the first .jar file in the folder
JAR_FILE=$(find "$FOLDER_PATH" -maxdepth 1 -name "*.jar" -type f | head -n 1)

# Check if a .jar file was found
if [ -z "$JAR_FILE" ]; then
    echo "Error: No .jar files found in '$FOLDER_PATH'"
    exit 1
fi

echo "Found jar file: $JAR_FILE"

# Check if /tmp/pack.zip exists
if [ ! -f $OTHER_ZIP ]; then
    echo "Error: $OTHER_ZIP does not exist"
    exit 1
fi

# Clean up previous extraction if it exists
if [ -d "/tmp/unzipped" ]; then
    echo "Removing previous /tmp/unzipped directory"
    rm -rf "/tmp/unzipped"
fi

# Create extraction directory
mkdir -p "/tmp/unzipped"

# Unzip the jar file
echo "Unzipping $JAR_FILE to /tmp/unzipped"
unzip -q "$JAR_FILE" -d "/tmp/unzipped/"

# Unzip /tmp/pack.zip into the same directory
echo "Unzipping /tmp/pack.zip to /tmp/unzipped"
unzip -q $OTHER_ZIP -d "/tmp/unzipped/"

# Remove original jar file
rm -f "$JAR_FILE"

# Create new jar file with combined contents
echo "Creating new jar file: $JAR_FILE"
cd "/tmp/unzipped" && zip -qr "$JAR_FILE" ./*

# Clean up temporary directory
echo "Cleaning up temporary files"
rm -rf "/tmp/unzipped"

echo "Process completed successfully!"
echo "Original file backed up as: $BACKUP_FILE"
echo "New jar file created: $JAR_FILE"